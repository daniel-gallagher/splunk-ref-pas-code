<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>User Details</title>
    <link rel="shortcut icon" href="{{SPLUNKWEB_URL_PREFIX}}/static/img/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/build/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="all" href="{{SPLUNKWEB_URL_PREFIX}}/../dj/static/splunkjs/css/dashboard.css" />

    <!--[if IE 7]><link rel="stylesheet" href="{{SPLUNKWEB_URL_PREFIX}}/static/css/sprites-ie7.css" /><![endif]-->
</head>
<body class="simplexml preload locale-en">

<!-- 
BEGIN LAYOUT
This section contains the layout for the dashboard. Splunk uses proprietary
styles in <div> tags, similar to Bootstrap's grid system. 
-->
<a class="navSkip" href="#navSkip" tabindex="1">Screen reader users, click here to skip the navigation bar</a>
<div class="header">
    <div id="placeholder-splunk-bar">
        <a href="{{SPLUNKWEB_URL_PREFIX}}/app/launcher/home" class="brand" title="splunk &gt; listen to your data">splunk<strong>&gt;</strong></a>
    </div>
    <div id="placeholder-app-bar"></div>
</div>
<a id="navSkip"></a>
<div class="dashboard-body container-fluid main-section-body">
  
  <div class="dashboard-row">
    <div class="span12 dashboard-header clearfix">
      <h2>User Details</h2>
    </div>
  </div>

      <div class="dashboard-row">
        <div class="dashboard-cell" style="width: 100%;">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>Search Criteria</h3>
                    </div>
                    <div class="panel-body">
                        <div style="float:left">
                          <h6>&nbsp;Username: </h6>
                        </div>
                        <div id="userInput" style="float:left"></div>
                        <div id="timepicker" style="float:right"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-row">
      <div class="dashboard-cell" style="width:33%;">
        <div class="dashboard-panel">                
          <div class="panel-head">
            <h3>Activity Levels</h3>
          </div>
          <div class="dashboard-element"  id="activity_levels">
            <div class="panel-body"></div>                  
          </div>
        </div>
      </div>
      <div class="dashboard-cell" style="width:67%;">
        <div class="dashboard-panel">
          <div class="panel-head">
            <h3>Trend</h3>
          </div>

          <div class="panel-body">
            <div id="trend-chart-div"></div>
            <div id="zoom-chart-div"></div>
          </div>
        </div>
      </div>
    </div>

  <div class="dashboard-row" id="drilldown-row">
    <div class="dashboard-cell span-half">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>Top Events</h3>
                    </div>
                    <div class="panel-body">
                        <div id="events-table"></div>
                    </div>
                </div>
            </div>
        </div>
    <div class="dashboard-cell span-half">
            <div class="dashboard-panel">
                <div class="dashboard-element">
                    <div class="panel-head">
                        <h3>Top Documents</h3>
                    </div>
                    <div class="panel-body">
                        <div id="documents-table"></div>
                    </div>
                </div>
            </div>
        </div>
  </div>

  <div class="dashboard-row" id="raw_container" style="display:none;">
    <div class="dashboard-cell" style="width: 100%;">
      <div class="dashboard-panel">
        <div class="panel-head">
          <h3>Raw Events (User: {{"$user$"|token_safe}}, {{"$raw_search$"|token_safe}})</h3>
        </div>
        <div class="panel-body">
          {% table id="raw-table" managerid="raw-search"%}
        </div>
      </div>
    </div>
  </div>
</div>
<div class="footer"></div>

<!-- 
END LAYOUT
-->

<script src="{{SPLUNKWEB_URL_PREFIX}}/config?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/i18n.js"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/i18ncatalog?autoload=1"></script>
<script src="{{SPLUNKWEB_URL_PREFIX}}/static/js/build/simplexml.min/config.js"></script>
<script type="text/javascript">
require.config({
    baseUrl: "{{SPLUNKWEB_URL_PREFIX}}/static/js",
    waitSeconds: 0,// Disable require.js load timeout
    paths:
    {
        "app": "../app"
    } 
});

//
// LIBRARY REQUIREMENTS
//
// In the require function, we include the necessary libraries and modules for
// the HTML dashboard. Then, we pass variable names for these libraries and
// modules as function parameters, in order.
// 
// When you add libraries or modules, remember to retain this mapping order
// between the library or module and its function parameter. You can do this by
// adding to the end of these lists, as shown in the commented examples below.

require([
    "splunkjs/mvc",
    "splunkjs/mvc/utils",
    "splunkjs/mvc/tokenutils",
    "underscore",
    "jquery",
    "splunkjs/mvc/simplexml",
    "splunkjs/mvc/headerview",
    "splunkjs/mvc/footerview",
    "splunkjs/mvc/simplexml/element/chart",
    "splunkjs/mvc/simplexml/element/event",
    "splunkjs/mvc/simplexml/element/html",
    "splunkjs/mvc/simplexml/element/list",
    "splunkjs/mvc/simplexml/element/map",
    "splunkjs/mvc/simplexml/element/single",
    "splunkjs/mvc/simplexml/element/table",
    "splunkjs/mvc/simpleform/formutils",
    "splunkjs/mvc/simpleform/input/dropdown",
    "splunkjs/mvc/simpleform/input/radiogroup",
    "splunkjs/mvc/simpleform/input/multiselect",
    "splunkjs/mvc/simpleform/input/checkboxgroup",
    "splunkjs/mvc/simpleform/input/text",
    "splunkjs/mvc/simpleform/input/timerange",
    "splunkjs/mvc/simpleform/input/submit",
    "splunkjs/mvc/searchmanager",
    "splunkjs/mvc/savedsearchmanager",
    "splunkjs/mvc/postprocessmanager",
    "splunkjs/mvc/simplexml/urltokenmodel",
    "app/warum_conducive_web/purl",
    "app/warum_conducive_web/components/calendarheatmap/calendarheatmap"

    // Add comma-separated libraries and modules manually here, for example:
    // ..."splunkjs/mvc/simplexml/urltokenmodel",
    // "splunkjs/mvc/checkboxview"
    ],
    function(
        mvc,
        utils,
        TokenUtils,
        _,
        $,
        HeaderView,
        FooterView,
        ChartElement,
        EventElement,
        HtmlElement,
        ListElement,
        MapElement,
        SingleElement,
        TableElement,
        FormUtils,
        DropdownInput,
        RadioGroupInput,
        MultiSelectInput,
        CheckboxGroupInput,
        TextInput,
        TimeRangeInput,
        SubmitButton,
        SearchManager,
        SavedSearchManager,
        PostProcessManager,
        UrlTokenModel

        // Add comma-separated parameter names here, for example: 
        // ...UrlTokenModel, 
        // CheckboxView
        ) {



        // 
        // TOKENS
        //
        
        // Create token namespaces
        var urlTokenModel = new UrlTokenModel();
        mvc.Components.registerInstance('url', urlTokenModel);
        var defaultTokenModel = mvc.Components.getInstance('default', {create: true});
        var submittedTokenModel = mvc.Components.getInstance('submitted', {create: true});

        urlTokenModel.on('url:navigate', function() {
            defaultTokenModel.set(urlTokenModel.toJSON());
            if (!_.isEmpty(urlTokenModel.toJSON()) && !_.all(urlTokenModel.toJSON(), _.isUndefined)) {
                submitTokens();
            } else {
                submittedTokenModel.clear();
            }
        });

        // Initialize tokens
        defaultTokenModel.set(urlTokenModel.toJSON());

        function submitTokens() {
            // Copy the contents of the defaultTokenModel to the submittedTokenModel and urlTokenModel
            FormUtils.submitForm({ replaceState: pageLoading });
        }

        function setToken(name, value) {
            defaultTokenModel.set(name, value);
            submittedTokenModel.set(name, value);
        }

        function unsetToken(name) {
            defaultTokenModel.unset(name);
            submittedTokenModel.unset(name);
        }

        //
        // SEARCH MANAGERS
        //
        var activity_levels_search = new SearchManager({
                "id": "activity_levels_search",
                "earliest": "$earliest$",
                "latest": "$latest$",
                "cancelOnUnload": true,
                "status_buckets": 0,
                "search": "index=warum user=$user$ | timechart span=1d count",
                "auto_cancel": 90,
                "preview": true,
                "runWhenTimeIsUndefined": false
            }, {tokens: true});

        var base_search = new SearchManager({
                "id": "base_search",
                "earliest": "$earliest$",
                "latest": "$latest$",
                "cancelOnUnload": true,
                "search": "index=warum sourcetype=ri:pas:application user=$user$ | bucket span=5m _time | stats count by _time event_name event_target",
                "preview": true
            }, {tokens: true});

        var zoom_search = new SearchManager({
                "id": "zoom_search",
                "earliest": "$earliest$",
                "latest": "$latest$",
                "cancelOnUnload": true,
                "search": "index=warum sourcetype=ri:pas:application user=$user$ | bucket span=5m _time | stats count by _time event_name user | timechart sum(count)",
                "preview": true
            }, {tokens: true});

        var raw_search = new SearchManager({
                "id": "raw_search",
                "earliest": "$earliest$",
                "latest": "$latest$",
                "cancelOnUnload": true,
                "search": "index=warum sourcetype=ri:pas:application user=$user$ $raw_search$",
                "preview": true
            }, {tokens: true});

        var trend_search = new PostProcessManager({
            "id": "trend_search",
            "managerid": "base_search",
            "search": "timechart sum(count) by event_name"
        });

        var top_events = new PostProcessManager({
            "id": "top_events",
            "managerid": "base_search",
            "search": "top event_name | eval percent=round(percent,2)"
        });

        var top_documents = new PostProcessManager({
            "id": "top_documents",
            "managerid": "base_search",
            "search": "top event_target | eval percent=round(percent,2)"
        });

        //
        // SPLUNK HEADER AND FOOTER
        //

        new HeaderView({
            id: 'header',
            section: 'dashboards',
            el: $('.header'),
            acceleratedAppNav: true,
            useSessionStorageCache: true
        }, {tokens: true}).render();

        new FooterView({
            id: 'footer',
            el: $('.footer')
        }, {tokens: true}).render();

        //
        // DASHBOARD EDITOR
        //

        // new Dashboard({
        //     id: 'dashboard',
        //     el: $('.dashboard-body')
        // }, {tokens: true}).render();


        //
        // VIEWS: VISUALIZATION ELEMENTS
        //

        var ChartView = require("splunkjs/mvc/chartview");
        var TextInputView = require("splunkjs/mvc/textinputview");
        var TimeRangeView = require("splunkjs/mvc/timerangeview");
        var SearchManager = require("splunkjs/mvc/searchmanager");
        var TableView = require("splunkjs/mvc/tableview");
        var CalendarHeatmap = require("app/warum_conducive_web/components/calendarheatmap/calendarheatmap");

        var drilldown_div = $("#drilldown-row");
        var tokens = mvc.Components.getInstance("default");

        var events_table = new TableView({
            "id": "events_table",
            "managerid": "top_events",
            el: $("events-table")
        }).render();
        var documents_table = new TableView({
            "id": "documents_table",
            "managerid": "top_documents",
            el: $("documents-table")
        }).render();



        var params = getQueryStringParams();
        if (params.user) {
          tokens.set("user",decodeURI(params.user));
          tokens.set("earliest",params.earliest);
          tokens.set("latest",params.latest);
          value = {
              earliest_time: tokens.get("earliest"),
              latest_time: tokens.get("latest")
          };
        }
        else {
          value = {
            earliest_time: "-24h",
            latest_time: "now"
          }
        }

        var timerange = new TimeRangeView({
            id: "timepicker",
            dialogOptions: {
                showCustomRealTime: false,
                showPresetsRealTime: false,
                enableCustomAdvancedRealTime: false,
                preset: "Last 24 hours"
            },
            el: $("#timepicker"),
            value: value
        }).render();
        base_search.search.set(timerange.val());
        zoom_search.search.set(timerange.val());
        activity_levels_search.search.set(timerange.val());
        
        var activity_levels = new CalendarHeatmap({
          id : "activity_levels",
          managerid : "activity_levels_search",
          domain : "month",
          subDomain : "x_day",
          el : $("#activity_levels")
        }).render();


        timerange.on("change", function() {
          base_search.search.set(timerange.val());
          zoom_search.search.set(timerange.val());
          activity_levels_search.search.set(timerange.val());

          /*tokens.set("earliest",params.earliest);
          tokens.set("latest",params.latest);*/
        });

        new TextInputView({
          id: "userInput",
          el: $("#userInput"),
          default: "*",
          value: mvc.tokenSafe("$user$")
        }).render();

        zoomchart = new ChartView({
          height: "100px",
          managerid: "zoom_search",
          type: "line",
          "charting.axisTitleX.visibility" : "collapsed",
          "charting.axisTitleY.visibility" : "collapsed",
          el: $("#zoom-chart-div")
        }).render();

        zoomchart.on("selection", function(e) {
          e.preventDefault();
          time_value = {
            earliest_time : e.startValue,
            latest_time : e.endValue
          };
          base_search.search.set(time_value);
          tokens.set("earliest",e.startValue);
          tokens.set("latest",e.endValue);
        });

        barchart = new ChartView({
          id: "trend_chart",
          managerid: "trend_search",
          type: "column",
          "charting.chart.stackMode": "stacked",
          "charting.axisTitleX.visibility" : "collapsed",
          drilldownRedirect: false,
          el: $("#trend-chart-div")
        }).render();

        documents_table.on("click:row", function(e) {
          e.preventDefault();
          event_target = e.data["row.event_target"].replace(/\\/g,"\\\\");
          tokens.set("raw_search","event_target=" + event_target);
          $("#raw_container").show();
        });

        events_table.on("click:row", function(e) {
          e.preventDefault();
          eventname = e.data["row.event_name"];
          tokens.set("raw_search","event_name=" + eventname);
          $("#raw_container").show();
        });


        // Initialize time tokens to default
        if (!defaultTokenModel.has('earliest') && !defaultTokenModel.has('latest')) {
            defaultTokenModel.set({ earliest: '0', latest: '' });
        }

        submitTokens();


    }
);
</script>
</body>
</html>
