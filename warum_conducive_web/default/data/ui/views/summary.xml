<form script="summary.js" stylesheet="summary.css,tagmanager.css">
    <label>Summary</label>
    <search id="base_search">
        <query>
            | pivot ri_pas_datamodel Root_Event count(Root_Event) AS Count SPLITROW _time AS _time PERIOD auto SPLITROW user AS user SPLITROW command AS command SPLITROW object AS object FILTER command isNotNull $filter$ $exclude$ ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 1
        </query>
    </search>
    <search id="policy_violations_search">
        <query>
                       | pivot ri_pas_datamodel Invalid_Time_Access SPLITROW department count(Invalid_Time_Access) as Invalid_Time_Access
                       | eval ViolationType="Invalid_Time_Access"
                       | rename Invalid_Time_Access as ViolationCount
            | append [ | pivot ri_pas_datamodel Terminated_Access   SPLITROW department count(Terminated_Access)   as Terminated_Access
                       | eval ViolationType="Terminated_Access"
                       | rename Terminated_Access as ViolationCount ]
            | append [ | search index=warum
                       | fields _time, user
                       | bucket _time span=1h
                       | stats count as ops by _time, user
                       | where ops!=0
                       | stats stdev(ops) as SD, avg(ops) as MEAN, latest(ops) as LAST_OPS by user
                       | where LAST_OPS > (MEAN + SD*1)
                       | lookup employee_details user
                       | stats count as ViolationCount by department
                       | eval ViolationType="Excessive_Access" ]
            | lookup violation_info ViolationType
            | eval TotalViolationWeight = ViolationCount*ViolationWeight
        </query>
        <earliest>@d</earliest>
        <latest>now</latest>
    </search>
    <search id="policy_violations_color_summary" base="policy_violations_search">
        <query>
            | stats sum(TotalViolationWeight) as TotalWeight,
                    sum(ViolationCount)       as ViolationCount
              by department, ViolationColor
            
            | eval NumYellows=if(ViolationColor="Yellow", ViolationCount, 0)
            | eval NumReds=   if(ViolationColor="Red",    ViolationCount, 0)
            | stats sum(NumReds)     as NumReds,
                    sum(NumYellows)  as NumYellows,
                    sum(TotalWeight) as TotalWeight
              by department
            | table department, NumYellows, NumReds, TotalWeight
        </query>
        <earliest>@d</earliest>
        <latest>now</latest>
    </search>
    <fieldset autoRun="true" submitButton="false">
        <input id="timerange" type="time" searchWhenChanged="true">
            <default>
                <earliestTime>-24h</earliestTime>
                <latestTime>now</latestTime>
            </default>
        </input>
    </fieldset>
    <row>
        <html>
            <div class="filter_tags">
                <h3>Filter Criteria:</h3>
                <input id="filter_tags_input" type="text"/>
            </div>
        </html>
    </row>
    <row>
        <panel id="policy_violations_panel">
            <html>
                <h3>Policy Violations</h3>
                <div class="donut_series"></div>
            </html>
        </panel>
        <panel id="policy_single_panel">
            <table>
                <title>Suspicious Activity</title>
                <search id="policy_violations_type_summary" base="policy_violations_search">
                    <query>
                        | stats values(ViolationColor)     as ViolationColor,
                                values(ViolationTypeTitle) as ViolationTypeTitle
                                sum(ViolationCount)        as ViolationCount
                          by ViolationType
                        | eval Type = ViolationTypeTitle . " (" . ViolationCount . ")"
                        | rename ViolationColor as C
                        | table C, Type
                    </query>
                    <earliest>@d</earliest>
                    <latest>now</latest>
                </search>
            </table>
        </panel>
    </row>
    <row>
        <chart id="trend_chart">
            <title>Trend</title>
            <searchString>| pivot ri_pas_datamodel Root_Event count(Root_Event) AS count SPLITROW _time AS _time PERIOD auto SPLITCOL command FILTER command isNotNull $filter$ $exclude$ SORT 0 _time ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 10 SHOWOTHER 0</searchString>
            <option name="charting.chart">column</option>
            <option name="charting.chart.stackMode">stacked</option>
            <option name="drilldown">none</option>
        </chart>
    </row>
    <row id="filter_header">
        <html>
            <h3>Tables Below Filtered on Event Type of $command$</h3>
            <div style="float: right; margin-top: -5px;">
                <button id="reset_filter" class="btn btn-primary">Remove Filter</button>
            </div>
        </html>
    </row>
    <row>
        <table id="user_table">
            <title>Top Users</title>
            <search id="top_users_search" base="base_search">
                <query>stats count by user | sort - count</query>
            </search>
        </table>
        <table id="document_table">
            <title>Top Documents</title>
            <search id="top_documents_search" base="base_search">
                <query>stats count by object | sort - count</query>
            </search>
        </table>
    </row>
</form>